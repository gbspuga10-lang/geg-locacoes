<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeG - Loca√ß√µes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .tab-content { transition: all 0.2s ease; }
        input:focus, select:focus { border-color: #f97316 !important; outline: none; ring: 2px; ring-color: #f97316; }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e293b; z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-slate-900 pb-10">

    <div id="loginOverlay">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <img src="logogg.jpeg" alt="GeG" class="h-20 mx-auto mb-6">
            <h2 class="text-slate-800 font-black uppercase tracking-widest mb-4">Acesso Restrito</h2>
            <input type="password" id="inputSenha" placeholder="Digite a senha" class="w-full border-2 border-slate-200 p-3 rounded-lg mb-4 text-center">
            <button type="button" onclick="verificarSenha()" class="w-full bg-orange-500 text-white font-black py-4 rounded-lg uppercase">Entrar</button>
            <p id="erroSenha" class="text-red-500 text-xs mt-3 font-bold hidden">Senha incorreta!</p>
        </div>
    </div>

    <div id="conteudoSistema" style="display: none;">
        <nav class="bg-slate-800 text-white p-3 shadow-xl mb-4 border-b-4 border-orange-500 sticky top-0 z-50">
            <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <img src="logogg.jpeg" alt="GeG" class="h-12">
                <div class="flex flex-wrap justify-center gap-3 items-center text-[10px] md:text-xs">
                    <button onclick="showTab('clientes')" class="hover:text-orange-400 font-bold uppercase">Clientes</button>
                    <button onclick="showTab('equipamentos')" class="hover:text-orange-400 font-bold uppercase">Materiais</button>
                    <button onclick="abrirRelatorio()" class="hover:text-orange-400 font-bold uppercase">Relat√≥rios</button>
                    <button onclick="logout()" class="text-red-400 font-bold uppercase">Sair</button>
                    <button onclick="showTab('locacao')" class="bg-orange-500 text-white px-4 py-2 rounded font-black uppercase">+ Loca√ß√£o</button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto p-2 md:p-4">
            <section id="locacao" class="tab-content bg-white rounded-lg shadow-xl max-w-2xl mx-auto overflow-hidden">
                <div class="bg-slate-800 p-3 text-center text-white font-black uppercase text-sm">Registrar Loca√ß√£o</div>
                <div class="p-4 md:p-8">
                    <form id="formLocacao" class="space-y-4" onsubmit="return false;">
                        <input type="text" id="nome" list="listaClientes" oninput="preencherDadosCliente(this.value)" placeholder="Nome do Cliente" class="w-full border-2 border-slate-200 p-3 rounded-lg">
                        <datalist id="listaClientes"></datalist>
                        <input type="text" id="endereco" placeholder="Endere√ßo de Entrega" class="w-full border-2 border-slate-200 p-3 rounded-lg">
                        <select id="item" class="w-full border-2 border-slate-200 p-3 rounded-lg font-semibold"></select>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[10px] font-bold text-slate-400">IN√çCIO</label><input type="date" id="dataInicio" class="w-full border-2 border-slate-200 p-3 rounded-lg"></div>
                            <div><label class="text-[10px] font-bold text-slate-400">RETORNO</label><input type="date" id="dataFim" class="w-full border-2 border-slate-200 p-3 rounded-lg"></div>
                        </div>
                        <div class="relative"><span class="absolute left-3 top-3 text-slate-400 font-bold">R$</span><input type="text" id="valor" oninput="mascaraMoeda(this)" placeholder="0,00" class="w-full border-2 border-slate-200 p-3 pl-10 rounded-lg font-black text-xl"></div>
                        <button type="button" onclick="salvar('locacao')" class="w-full bg-slate-800 text-white py-4 rounded-lg font-black uppercase">Lan√ßar Loca√ß√£o</button>
                    </form>
                </div>
            </section>

            <section id="relatorios" class="tab-content hidden">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="bg-slate-700 p-3 rounded-lg border-l-4 border-orange-500 text-white"><p class="text-[8px] font-black uppercase">Receita Ativa</p><h3 id="dashTotal" class="text-sm md:text-2xl font-black">R$ 0,00</h3></div>
                    <div class="bg-white p-3 rounded-lg border-l-4 border-red-500"><p class="text-[8px] font-black uppercase">Atrasos</p><h3 id="dashAtraso" class="text-sm md:text-2xl font-black text-red-600">0</h3></div>
                    <div class="bg-slate-700 p-2 col-span-2 flex items-center"><input type="text" id="inputBusca" onkeyup="filtrarTabela()" placeholder="üîç Buscar..." class="w-full bg-slate-600 text-white rounded p-2 text-xs"></div>
                </div>
                <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                    <div class="table-container">
                        <table class="w-full text-left min-w-[800px]">
                            <thead class="bg-slate-100 text-[10px] font-black uppercase">
                                <tr><th class="p-3">Cliente</th><th class="p-3">Equipamento</th><th class="p-3 text-center">Retorno</th><th class="p-3">Valor</th><th class="p-3 text-center">Status</th><th class="p-3 text-center">A√ß√µes</th></tr>
                            </thead>
                            <tbody id="tabelaDados" class="text-xs"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <section id="clientes" class="tab-content hidden bg-white p-4 rounded-lg max-w-2xl mx-auto">
                <h2 class="font-black mb-4">Novo Cliente</h2>
                <form id="formCliente" class="space-y-3">
                    <input type="text" id="cli_nome" placeholder="Nome" class="w-full border-2 p-2 rounded">
                    <button type="button" onclick="salvar('cliente')" class="w-full bg-slate-800 text-white p-3 rounded font-bold uppercase">Cadastrar</button>
                </form>
            </section>

            <section id="equipamentos" class="tab-content hidden bg-white p-4 rounded-lg max-w-2xl mx-auto">
                <h2 class="font-black mb-4">Novo Material</h2>
                <form id="formMaterial" class="space-y-3">
                    <input type="text" id="mat_nome" placeholder="Nome do Equipamento" class="w-full border-2 p-2 rounded">
                    <button type="button" onclick="salvar('material')" class="w-full bg-slate-800 text-white p-3 rounded font-bold uppercase">Salvar</button>
                </form>
            </section>
        </div>
    </div>

    <script>
        const SENHA_ACESSO = "Geg@0612";
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyLDvIJ7BeQ5tLDKU8adTf3jqzKdWCQLIMXqxvGbVGHUOkPyBhEzUat2hlNb6xAdNQJEw/exec";

        function verificarSenha() {
            if (document.getElementById('inputSenha').value === SENHA_ACESSO) {
                localStorage.setItem('geg_autenticado', 'true');
                liberarSistema();
            } else { document.getElementById('erroSenha').classList.remove('hidden'); }
        }

        window.onload = () => { if(localStorage.getItem('geg_autenticado') === 'true') liberarSistema(); };

        function liberarSistema() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('conteudoSistema').style.display = 'block';
            carregarEquipamentos(); carregarClientes();
        }

        function logout() { localStorage.removeItem('geg_autenticado'); location.reload(); }
        function showTab(id) { document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        function mascaraMoeda(i) { let v = i.value.replace(/\D/g, ""); v = (v/100).toFixed(2).replace(".", ","); i.value = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1."); }

        async function carregarEquipamentos() {
            try {
                const r = await fetch(URL_SCRIPT + "?aba=Equipamentos");
                const dados = await r.json();
                const sel = document.getElementById('item');
                sel.innerHTML = '<option value="">Selecione o Material...</option>';
                dados.forEach(e => { if(e[3] === "Dispon√≠vel") sel.innerHTML += `<option value="${e[0]}">${e[0]} (${e[1]})</option>`; });
            } catch(e) { console.error("Erro materiais:", e); }
        }

        async function carregarClientes() {
            try {
                const r = await fetch(URL_SCRIPT + "?aba=Clientes");
                const dados = await r.json();
                const dl = document.getElementById('listaClientes'); dl.innerHTML = '';
                dados.forEach(c => { if(c[0]) dl.innerHTML += `<option value="${c[0]}">`; });
            } catch(e) { }
        }

        async function abrirRelatorio() {
            showTab('relatorios');
            const tb = document.getElementById('tabelaDados');
            tb.innerHTML = "<tr><td colspan='6' class='p-10 text-center font-bold text-slate-400'>Sincronizando...</td></tr>";
            
            try {
                const r = await fetch(URL_SCRIPT + "?aba=Locacoes");
                const dados = await r.json();
                tb.innerHTML = "";
                
                let soma = 0, atrasos = 0;
                const hoje = new Date(); hoje.setHours(0,0,0,0);

                dados.forEach(l => {
                    try {
                        if(!l[0] || l[0] === "Nome") return; // Ignora cabe√ßalho ou linhas vazias

                        const status = l[7] || "Ativo";
                        const valor = parseFloat(l[4]) || 0;
                        
                        // TRATAMENTO SEGURO DE DATA
                        let dataFim;
                        if (l[6] instanceof Date) { dataFim = l[6]; } 
                        else {
                            let dataStr = String(l[6]);
                            if(dataStr.includes('/')) {
                                let pts = dataStr.split('/');
                                dataFim = new Date(pts[2], pts[1]-1, pts[0]);
                            } else { dataFim = new Date(dataStr); }
                        }
                        
                        const isVencido = (status === "Ativo" && hoje > dataFim);
                        if(status === "Ativo") { soma += valor; if(isVencido) atrasos++; }

                        tb.innerHTML += `
                            <tr class="border-b ${isVencido ? 'bg-red-50' : ''}">
                                <td class="p-3 font-bold">${l[0]}</td>
                                <td class="p-3">${l[3]}</td>
                                <td class="p-3 text-center">${dataFim.toLocaleDateString('pt-BR')}</td>
                                <td class="p-3 font-bold">R$ ${valor.toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
                                <td class="p-3 text-center">
                                    <span class="px-2 py-1 rounded text-[9px] font-black ${status === 'Ativo' ? 'bg-slate-800 text-orange-400' : 'bg-gray-100 text-gray-400'}">${status}</span>
                                </td>
                                <td class="p-3 text-center">
                                    <button onclick="finalizarLocacao(${l[8]})" class="bg-orange-500 text-white px-2 py-1 rounded text-[10px] font-bold">FIM</button>
                                </td>
                            </tr>`;
                    } catch(e) { console.error("Erro na linha:", e); }
                });

                document.getElementById('dashTotal').innerText = `R$ ${soma.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
                document.getElementById('dashAtraso').innerText = atrasos;

            } catch(e) { 
                tb.innerHTML = "<tr><td colspan='6' class='p-10 text-center text-red-500'>Erro ao carregar. Verifique a conex√£o.</td></tr>";
            }
        }

        async function salvar(tipo) {
            let payload = { tipo: tipo };
            if (tipo === 'locacao') {
                payload.nome = document.getElementById('nome').value;
                payload.item = document.getElementById('item').value;
                payload.valor = document.getElementById('valor').value.replace(/\./g, "").replace(",", ".");
                payload.dataInicio = document.getElementById('dataInicio').value;
                payload.dataFim = document.getElementById('dataFim').value;
                payload.endereco = document.getElementById('endereco').value;
            }
            // ... outros tipos (cliente/material) simplificados
            try {
                await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert("‚úÖ Sucesso!"); 
                if(tipo === 'locacao') document.getElementById('formLocacao').reset();
            } catch(e) { alert("Erro ao salvar."); }
        }

        async function finalizarLocacao(linha) {
            if(!confirm("Finalizar loca√ß√£o?")) return;
            await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify({tipo: 'finalizar', linha: linha}) });
            abrirRelatorio();
        }

        function filtrarTabela() {
            let f = document.getElementById("inputBusca").value.toUpperCase();
            document.querySelectorAll("#tabelaDados tr").forEach(tr => {
                tr.style.display = tr.innerText.toUpperCase().includes(f) ? "" : "none";
            });
        }
    </script>
</body>
</html>
