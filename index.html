<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeG - Loca√ß√µes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .tab-content { transition: all 0.2s ease; }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e293b; z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        input:focus, select:focus { border-color: #f97316 !important; outline: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-slate-900 pb-10">

    <div id="loginOverlay">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <img src="logogg.jpeg" alt="GeG" class="h-20 mx-auto mb-6">
            <input type="password" id="inputSenha" placeholder="Senha de Acesso" class="w-full border-2 border-slate-200 p-3 rounded-lg mb-4 text-center">
            <button onclick="verificarSenha()" class="w-full bg-orange-500 text-white font-black py-4 rounded-lg uppercase shadow-lg hover:bg-orange-600">Entrar</button>
            <p id="erroSenha" class="text-red-500 text-xs mt-3 font-bold hidden">Senha incorreta!</p>
        </div>
    </div>

    <div id="conteudoSistema" style="display: none;">
        <nav class="bg-slate-800 text-white p-3 shadow-xl mb-4 border-b-4 border-orange-500 sticky top-0 z-50">
            <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <img src="logogg.jpeg" alt="GeG" class="h-12">
                <div class="flex flex-wrap justify-center gap-4 items-center text-[10px] md:text-xs font-black uppercase">
                    <button onclick="showTab('clientes')" class="hover:text-orange-400 transition">Clientes</button>
                    <button onclick="showTab('equipamentos')" class="hover:text-orange-400 transition">Materiais</button>
                    <button onclick="abrirRelatorio()" class="text-orange-400 transition">Relat√≥rios</button>
                    <button onclick="logout()" class="text-red-400 transition">Sair</button>
                    <button onclick="showTab('locacao')" class="bg-orange-500 px-4 py-2 rounded text-white transition">+ Loca√ß√£o</button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto p-2">
            
            <section id="locacao" class="tab-content bg-white rounded-lg shadow-xl max-w-2xl mx-auto overflow-hidden">
                <div class="bg-slate-800 p-3 text-center text-white font-black uppercase text-sm">Nova Loca√ß√£o</div>
                <div class="p-6 space-y-4">
                    <input type="text" id="loc_nome" list="listaClientes" placeholder="Nome do Cliente" class="w-full border-2 p-3 rounded-lg">
                    <datalist id="listaClientes"></datalist>
                    <input type="text" id="loc_cpf" placeholder="CPF/CNPJ" class="w-full border-2 p-3 rounded-lg">
                    <input type="text" id="loc_endereco" placeholder="Endere√ßo de Entrega" class="w-full border-2 p-3 rounded-lg">
                    <select id="loc_item" class="w-full border-2 p-3 rounded-lg font-semibold text-slate-700"></select>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-black text-slate-400">DATA IN√çCIO</label><input type="date" id="loc_inicio" class="w-full border-2 p-3 rounded-lg"></div>
                        <div><label class="text-[10px] font-black text-slate-400">DATA RETORNO</label><input type="date" id="loc_fim" class="w-full border-2 p-3 rounded-lg"></div>
                    </div>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-slate-400 font-bold">R$</span>
                        <input type="text" id="loc_valor" oninput="mascaraMoeda(this)" placeholder="0,00" class="w-full border-2 p-3 pl-10 rounded-lg font-black text-xl text-orange-600">
                    </div>
                    <button onclick="salvarLocacao()" class="w-full bg-slate-800 text-white py-4 rounded-lg font-black uppercase hover:bg-orange-500 transition">Lan√ßar no Sistema</button>
                </div>
            </section>

            <section id="clientes" class="tab-content hidden bg-white rounded-lg shadow-xl max-w-2xl mx-auto overflow-hidden">
                <div class="bg-slate-800 p-3 text-center text-white font-black uppercase text-sm">Novo Cliente</div>
                <div class="p-6 space-y-4">
                    <input type="text" id="cli_nome" placeholder="Nome Completo / Raz√£o Social" class="w-full border-2 p-3 rounded-lg">
                    <input type="text" id="cli_cpf" placeholder="CPF ou CNPJ" class="w-full border-2 p-3 rounded-lg">
                    <input type="text" id="cli_tel" placeholder="Telefone / WhatsApp" class="w-full border-2 p-3 rounded-lg">
                    <input type="text" id="cli_end" placeholder="Endere√ßo Completo" class="w-full border-2 p-3 rounded-lg">
                    <button onclick="salvarCliente()" class="w-full bg-slate-800 text-white py-4 rounded-lg font-black uppercase hover:bg-orange-500 transition">Cadastrar Cliente</button>
                </div>
            </section>

            <section id="equipamentos" class="tab-content hidden bg-white rounded-lg shadow-xl max-w-2xl mx-auto overflow-hidden">
                <div class="bg-slate-800 p-3 text-center text-white font-black uppercase text-sm">Novo Material</div>
                <div class="p-6 space-y-4">
                    <input type="text" id="mat_nome" placeholder="Nome do Equipamento (Ex: Andaime 1m)" class="w-full border-2 p-3 rounded-lg">
                    <input type="text" id="mat_pat" placeholder="N√∫mero de Patrim√¥nio / ID" class="w-full border-2 p-3 rounded-lg">
                    <input type="text" id="mat_val" oninput="mascaraMoeda(this)" placeholder="Valor Di√°ria/M√™s (Opcional)" class="w-full border-2 p-3 rounded-lg">
                    <select id="mat_status" class="w-full border-2 p-3 rounded-lg font-semibold text-slate-700">
                        <option value="Dispon√≠vel">Dispon√≠vel</option>
                        <option value="Manuten√ß√£o">Manuten√ß√£o</option>
                    </select>
                    <button onclick="salvarMaterial()" class="w-full bg-slate-800 text-white py-4 rounded-lg font-black uppercase hover:bg-orange-500 transition">Salvar Material</button>
                </div>
            </section>

            <section id="relatorios" class="tab-content hidden">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="bg-slate-700 p-3 rounded-lg border-l-4 border-orange-500 text-white">
                        <p class="text-[8px] font-black uppercase">Receita Ativa</p>
                        <h3 id="dashTotal" class="text-sm md:text-2xl font-black">R$ 0,00</h3>
                    </div>
                    <div class="bg-white p-3 rounded-lg border-l-4 border-red-500 shadow-md">
                        <p class="text-[8px] font-black uppercase text-red-600">Atrasos</p>
                        <h3 id="dashAtraso" class="text-sm md:text-2xl font-black text-red-600">0</h3>
                    </div>
                    <div class="bg-slate-700 p-2 rounded-lg flex items-center col-span-2">
                        <input type="text" id="inputBusca" onkeyup="filtrarTabela()" placeholder="üîç Buscar cliente ou item..." class="w-full bg-slate-600 text-white rounded p-2 text-xs outline-none">
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-xl overflow-hidden border border-slate-200">
                    <div class="table-container">
                        <table class="w-full text-left min-w-[950px]">
                            <thead>
                                <tr class="bg-slate-100 text-slate-600 uppercase text-[10px] font-black border-b">
                                    <th class="p-4">Cliente</th>
                                    <th class="p-4">Item</th>
                                    <th class="p-4 text-center">Retorno</th>
                                    <th class="p-4">Valor</th>
                                    <th class="p-4 text-center">Pagamento</th>
                                    <th class="p-4 text-center">Status</th>
                                    <th class="p-4 text-center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaDados" class="text-xs font-medium"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        const SENHA_ACESSO = "Geg@0612";
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyLDvIJ7BeQ5tLDKU8adTf3jqzKdWCQLIMXqxvGbVGHUOkPyBhEzUat2hlNb6xAdNQJEw/exec";
        
        function verificarSenha() {
            if (document.getElementById('inputSenha').value === SENHA_ACESSO) {
                localStorage.setItem('geg_autenticado', 'true');
                liberarSistema();
            } else { 
                document.getElementById('erroSenha').classList.remove('hidden'); 
            }
        }

        window.onload = () => { if(localStorage.getItem('geg_autenticado') === 'true') liberarSistema(); };

        function liberarSistema() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('conteudoSistema').style.display = 'block';
            carregarEquipamentos(); carregarClientes();
        }

        function logout() { localStorage.removeItem('geg_autenticado'); location.reload(); }
        function showTab(id) { document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        function mascaraMoeda(i) { let v = i.value.replace(/\D/g, ""); v = (v/100).toFixed(2).replace(".", ","); i.value = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1."); }

        // --- CARREGAMENTO ---
        async function carregarEquipamentos() {
            try {
                const r = await fetch(URL_SCRIPT + "?aba=Equipamentos");
                const dados = await r.json();
                const sel = document.getElementById('loc_item');
                sel.innerHTML = '<option value="">Selecione o Material...</option>';
                dados.forEach(item => {
                    const e = item.valores;
                    if(e[3] === "Dispon√≠vel") sel.innerHTML += `<option value="${e[0]}">${e[0]}</option>`;
                });
            } catch(e) { console.log(e) }
        }

        async function carregarClientes() {
            try {
                const r = await fetch(URL_SCRIPT + "?aba=Clientes");
                const dados = await r.json();
                const dl = document.getElementById('listaClientes'); dl.innerHTML = '';
                dados.forEach(item => {
                    const c = item.valores;
                    if(c[0]) dl.innerHTML += `<option value="${c[0]}">`;
                });
            } catch(e) {}
        }

        // --- SALVAMENTO ---
        async function salvarLocacao() {
            let p = { 
                tipo: 'locacao',
                nome: document.getElementById('loc_nome').value,
                cpf: document.getElementById('loc_cpf').value,
                endereco: document.getElementById('loc_endereco').value,
                item: document.getElementById('loc_item').value,
                valor: document.getElementById('loc_valor').value.replace(/\./g, "").replace(",", "."),
                dataInicio: document.getElementById('loc_inicio').value,
                dataFim: document.getElementById('loc_fim').value
            };
            await enviar(p);
            document.getElementById('loc_nome').value = '';
        }

        async function salvarCliente() {
            let p = {
                tipo: 'cliente',
                nome: document.getElementById('cli_nome').value,
                cpf: document.getElementById('cli_cpf').value,
                telefone: document.getElementById('cli_tel').value,
                endereco: document.getElementById('cli_end').value
            };
            await enviar(p);
            document.getElementById('cli_nome').value = '';
        }

        async function salvarMaterial() {
            let p = {
                tipo: 'material',
                nome: document.getElementById('mat_nome').value,
                patrimonio: document.getElementById('mat_pat').value,
                valor: document.getElementById('mat_val').value.replace(/\./g, "").replace(",", "."),
                status: document.getElementById('mat_status').value
            };
            await enviar(p);
            document.getElementById('mat_nome').value = '';
        }

        async function enviar(payload) {
            try {
                await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert("‚úÖ Registrado com sucesso!");
                carregarEquipamentos(); carregarClientes();
            } catch(e) { alert("Erro ao salvar."); }
        }

        // --- RELAT√ìRIO ---
        async function abrirRelatorio() {
            showTab('relatorios');
            const tb = document.getElementById('tabelaDados');
            tb.innerHTML = "<tr><td colspan='7' class='p-10 text-center font-black text-slate-400'>Sincronizando...</td></tr>";
            try {
                const r = await fetch(URL_SCRIPT + "?aba=Locacoes");
                const dados = await r.json();
                tb.innerHTML = "";
                let soma = 0, atrasos = 0;
                const hoje = new Date(); hoje.setHours(0,0,0,0);

                dados.forEach(item => {
                    const l = item.valores;
                    const numLinha = item.numeroLinha;
                    if(!l[0] || l[0] === "Nome") return;
                    
                    const valor = parseFloat(String(l[4]).replace(",", ".")) || 0;
                    const status = l[7] || "Ativo";
                    const pagamento = l[9] || l[8] || "Pendente"; 
                    
                    let dFim = new Date(l[6]);
                    if(isNaN(dFim.getTime())) {
                        const p = String(l[6]).split('/');
                        dFim = new Date(p[2], p[1]-1, p[0]);
                    }
                    dFim.setHours(23,59,59,0);
                    const isVencido = (status === "Ativo" && hoje > dFim);
                    if(status === "Ativo") { soma += valor; if(isVencido) atrasos++; }

                    tb.innerHTML += `
                        <tr class="border-b hover:bg-slate-50 ${isVencido ? 'bg-red-50' : ''} transition">
                            <td class="p-4 font-bold text-slate-800">${l[0]}</td>
                            <td class="p-4 text-slate-600">${l[3]}</td>
                            <td class="p-4 text-center">${dFim.toLocaleDateString('pt-BR')}</td>
                            <td class="p-4 font-black">R$ ${valor.toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
                            <td class="p-4 text-center">
                                <button onclick="mudarPagamento(${numLinha}, '${pagamento}')" class="px-2 py-1 rounded text-[10px] font-bold ${pagamento === 'Pago' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'} transition">${pagamento}</button>
                            </td>
                            <td class="p-4 text-center">
                                <span class="px-2 py-1 rounded text-[9px] font-black uppercase ${status === 'Ativo' ? 'bg-slate-800 text-orange-400' : 'bg-gray-200 text-gray-500'}">${status}</span>
                            </td>
                            <td class="p-4 text-center">
                                <div class="flex flex-row justify-center gap-2">
                                    ${status === 'Ativo' ? `
                                        <button onclick="finalizarLocacao(${numLinha})" 
                                            class="bg-orange-500 text-white px-3 py-2 rounded font-black text-[9px] uppercase hover:bg-orange-600 shadow-sm transition">
                                            Finalizar
                                        </button>
                                    ` : ''}
                                    <button onclick="excluirLocacao(${numLinha})" 
                                        class="bg-red-50 text-red-600 border border-red-100 px-3 py-2 rounded font-black text-[9px] uppercase hover:bg-red-600 hover:text-white shadow-sm transition">
                                        Excluir
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                });
                document.getElementById('dashTotal').innerText = `R$ ${soma.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
                document.getElementById('dashAtraso').innerText = atrasos;
            } catch(e) { tb.innerHTML = "<tr><td colspan='7' class='p-10 text-center text-red-500'>Erro ao carregar dados.</td></tr>"; }
        }

        async function mudarPagamento(linha, statusAtual) {
            const novo = statusAtual === 'Pago' ? 'Pendente' : 'Pago';
            await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify({tipo: 'pagamento', linha: linha, statusPagamento: novo}) });
            setTimeout(abrirRelatorio, 500);
        }

        async function finalizarLocacao(linha) {
            if(!confirm("Deseja marcar esta loca√ß√£o como FINALIZADA?")) return;
            await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify({tipo: 'finalizar', linha: linha}) });
            setTimeout(abrirRelatorio, 800);
        }

        async function excluirLocacao(linha) {
            if(!confirm("‚ö†Ô∏è ATEN√á√ÉO!\n\nDeseja excluir permanentemente esta linha da planilha?")) return;
            try {
                await fetch(URL_SCRIPT, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify({tipo: 'excluir', linha: linha}) 
                });
                setTimeout(abrirRelatorio, 800);
            } catch(e) { alert("Erro ao excluir."); }
        }

        function filtrarTabela() {
            let f = document.getElementById("inputBusca").value.toUpperCase();
            document.querySelectorAll("#tabelaDados tr").forEach(tr => {
                tr.style.display = tr.innerText.toUpperCase().includes(f) ? "" : "none";
            });
        }
    </script>
</body>
</html>
