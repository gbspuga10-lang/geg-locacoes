<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeG - Loca√ß√µes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .tab-content { transition: all 0.2s ease; }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e293b; z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .btn-status { transition: all 0.2s; }
        .btn-status:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-gray-100 font-sans text-slate-900 pb-10">

    <div id="loginOverlay">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <img src="logogg.jpeg" alt="GeG" class="h-20 mx-auto mb-6">
            <input type="password" id="inputSenha" placeholder="Senha" class="w-full border-2 border-slate-200 p-3 rounded-lg mb-4 text-center outline-none focus:border-orange-500">
            <button onclick="verificarSenha()" class="w-full bg-orange-500 text-white font-black py-4 rounded-lg uppercase shadow-lg">Entrar</button>
            <p id="erroSenha" class="text-red-500 text-xs mt-3 font-bold hidden">Senha incorreta!</p>
        </div>
    </div>

    <div id="conteudoSistema" style="display: none;">
        <nav class="bg-slate-800 text-white p-3 shadow-xl mb-4 border-b-4 border-orange-500 sticky top-0 z-50">
            <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                <img src="logogg.jpeg" alt="GeG" class="h-12">
                <div class="flex flex-wrap justify-center gap-4 items-center text-[10px] md:text-xs">
                    <button onclick="showTab('clientes')" class="font-bold uppercase">Clientes</button>
                    <button onclick="showTab('equipamentos')" class="font-bold uppercase">Materiais</button>
                    <button onclick="abrirRelatorio()" class="font-bold uppercase border-orange-500 text-orange-400">Relat√≥rios</button>
                    <button onclick="logout()" class="text-red-400 font-bold uppercase">Sair</button>
                    <button onclick="showTab('locacao')" class="bg-orange-500 px-4 py-2 rounded font-black uppercase">+ Loca√ß√£o</button>
                </div>
            </div>
        </nav>

        <div class="container mx-auto p-2">
            <section id="locacao" class="tab-content bg-white rounded-lg shadow-xl max-w-2xl mx-auto overflow-hidden">
                <div class="bg-slate-800 p-3 text-center text-white font-black uppercase text-sm">Registrar Loca√ß√£o</div>
                <div class="p-6 space-y-4">
                    <input type="text" id="nome" list="listaClientes" oninput="preencherDadosCliente(this.value)" placeholder="Nome do Cliente" class="w-full border-2 p-3 rounded-lg">
                    <datalist id="listaClientes"></datalist>
                    <input type="text" id="cpf" placeholder="CPF/CNPJ" class="w-full border-2 p-3 rounded-lg">
                    <input type="text" id="endereco" placeholder="Endere√ßo de Entrega" class="w-full border-2 p-3 rounded-lg">
                    <select id="item" class="w-full border-2 p-3 rounded-lg font-semibold"></select>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-bold text-slate-400">IN√çCIO</label><input type="date" id="dataInicio" class="w-full border-2 p-3 rounded-lg"></div>
                        <div><label class="text-[10px] font-bold text-slate-400">RETORNO</label><input type="date" id="dataFim" class="w-full border-2 p-3 rounded-lg"></div>
                    </div>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-slate-400 font-bold">R$</span>
                        <input type="text" id="valor" oninput="mascaraMoeda(this)" placeholder="0,00" class="w-full border-2 p-3 pl-10 rounded-lg font-black text-xl text-orange-600">
                    </div>
                    <button onclick="salvar('locacao')" class="w-full bg-slate-800 text-white py-4 rounded-lg font-black uppercase">Salvar Loca√ß√£o</button>
                </div>
            </section>

            <section id="relatorios" class="tab-content hidden">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="bg-slate-700 p-3 rounded-lg border-l-4 border-orange-500 text-white"><p class="text-[8px] font-black uppercase">Receita Ativa</p><h3 id="dashTotal" class="text-sm md:text-2xl font-black">R$ 0,00</h3></div>
                    <div class="bg-white p-3 rounded-lg border-l-4 border-red-500 shadow-md"><p class="text-[8px] font-black uppercase text-red-600">Atrasos</p><h3 id="dashAtraso" class="text-sm md:text-2xl font-black text-red-600">0</h3></div>
                    <div class="bg-slate-700 p-2 rounded-lg flex items-center col-span-2"><input type="text" id="inputBusca" onkeyup="filtrarTabela()" placeholder="üîç Buscar cliente ou item..." class="w-full bg-slate-600 text-white rounded p-2 text-xs outline-none"></div>
                </div>
                
                <div class="bg-white rounded-lg shadow-xl overflow-hidden border border-slate-200">
                    <div class="table-container">
                        <table class="w-full text-left min-w-[900px]">
                            <thead>
                                <tr class="bg-slate-100 text-slate-600 uppercase text-[10px] font-black border-b">
                                    <th class="p-4">Cliente</th>
                                    <th class="p-4">Item (D)</th>
                                    <th class="p-4 text-center">Retorno (G)</th>
                                    <th class="p-4">Valor (E)</th>
                                    <th class="p-4 text-center">Pagamento (I/J)</th>
                                    <th class="p-4 text-center">Status (H)</th>
                                    <th class="p-4 text-center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaDados" class="text-xs font-medium"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        const SENHA_ACESSO = "Geg@0612";
        const URL_SCRIPT = "https://script.google.com/macros/s/AKfycbyLDvIJ7BeQ5tLDKU8adTf3jqzKdWCQLIMXqxvGbVGHUOkPyBhEzUat2hlNb6xAdNQJEw/exec";
        
        function verificarSenha() {
            if (document.getElementById('inputSenha').value === SENHA_ACESSO) {
                localStorage.setItem('geg_autenticado', 'true');
                liberarSistema();
            } else { document.getElementById('erroSenha').classList.remove('hidden'); }
        }

        window.onload = () => { if(localStorage.getItem('geg_autenticado') === 'true') liberarSistema(); };

        function liberarSistema() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('conteudoSistema').style.display = 'block';
            carregarEquipamentos(); carregarClientes();
        }

        function logout() { localStorage.removeItem('geg_autenticado'); location.reload(); }
        function showTab(id) { document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
        function mascaraMoeda(i) { let v = i.value.replace(/\D/g, ""); v = (v/100).toFixed(2).replace(".", ","); i.value = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1."); }

        async function carregarEquipamentos() {
            try {
                const r = await fetch(URL_SCRIPT + "?aba=Equipamentos");
                const dados = await r.json();
                const sel = document.getElementById('item');
                sel.innerHTML = '<option value="">Selecione o Material...</option>';
                // O doGet novo envia objetos: {valores: [...]}
                dados.forEach(item => {
                    const e = item.valores;
                    if(e[3] === "Dispon√≠vel") sel.innerHTML += `<option value="${e[0]}">${e[0]}</option>`;
                });
            } catch(e) { console.log("Erro materiais", e) }
        }

        async function carregarClientes() {
            try {
                const r = await fetch(URL_SCRIPT + "?aba=Clientes");
                const dados = await r.json();
                const dl = document.getElementById('listaClientes'); dl.innerHTML = '';
                dados.forEach(item => {
                    const c = item.valores;
                    if(c[0]) dl.innerHTML += `<option value="${c[0]}">`;
                });
            } catch(e) {}
        }

        async function abrirRelatorio() {
            showTab('relatorios');
            const tb = document.getElementById('tabelaDados');
            tb.innerHTML = "<tr><td colspan='7' class='p-10 text-center font-black text-slate-400'>Sincronizando dados...</td></tr>";
            
            try {
                const r = await fetch(URL_SCRIPT + "?aba=Locacoes");
                const dadosRecebidos = await r.json();
                tb.innerHTML = "";
                
                let soma = 0, atrasos = 0;
                const hoje = new Date(); hoje.setHours(0,0,0,0);

                dadosRecebidos.forEach(item => {
                    const l = item.valores;
                    const numLinha = item.numeroLinha;

                    if(!l[0] || l[0] === "Nome") return;

                    try {
                        const valor = parseFloat(String(l[4]).replace(",", ".")) || 0;
                        const status = l[7] || "Ativo";
                        // Seu script salva o pagamento na Coluna 10 (√çndice 9)
                        const pagamento = l[9] || l[8] || "Pendente"; 
                        
                        let dFim = new Date(l[6]);
                        if(isNaN(dFim.getTime())) {
                            const p = String(l[6]).split('/');
                            dFim = new Date(p[2], p[1]-1, p[0]);
                        }
                        dFim.setHours(23,59,59,0);

                        const isVencido = (status === "Ativo" && hoje > dFim);
                        if(status === "Ativo") { soma += valor; if(isVencido) atrasos++; }

                        tb.innerHTML += `
                            <tr class="border-b hover:bg-slate-50 ${isVencido ? 'bg-red-50' : ''}">
                                <td class="p-4 font-bold text-slate-800">${l[0]}</td>
                                <td class="p-4 text-slate-600">${l[3]}</td>
                                <td class="p-4 text-center font-mono">${dFim.toLocaleDateString('pt-BR')}</td>
                                <td class="p-4 font-black text-slate-700">R$ ${valor.toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
                                <td class="p-4 text-center">
                                    <button onclick="mudarPagamento(${numLinha}, '${pagamento}')" class="btn-status px-2 py-1 rounded text-[10px] font-bold ${pagamento === 'Pago' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                        ${pagamento}
                                    </button>
                                </td>
                                <td class="p-4 text-center">
                                    <span class="px-2 py-1 rounded text-[9px] font-black uppercase ${status === 'Ativo' ? 'bg-slate-800 text-orange-400' : 'bg-gray-200 text-gray-500'}">${status}</span>
                                </td>
                                <td class="p-4 text-center">
                                    <button onclick="finalizarLocacao(${numLinha})" class="bg-orange-500 text-white px-3 py-1 rounded font-black text-[10px]">FIM</button>
                                </td>
                            </tr>`;
                    } catch(e) { console.log("Erro linha", e) }
                });

                document.getElementById('dashTotal').innerText = `R$ ${soma.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
                document.getElementById('dashAtraso').innerText = atrasos;

            } catch(e) {
                tb.innerHTML = "<tr><td colspan='7' class='p-10 text-center text-red-500'>Erro cr√≠tico ao carregar. Verifique o Script Google.</td></tr>";
            }
        }

        async function mudarPagamento(linha, statusAtual) {
            const novo = statusAtual === 'Pago' ? 'Pendente' : 'Pago';
            // Chama a fun√ß√£o 'pagamento' do seu doPost (Coluna 10)
            await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify({tipo: 'pagamento', linha: linha, statusPagamento: novo}) });
            setTimeout(abrirRelatorio, 500);
        }

        async function salvar(tipo) {
            let payload = { 
                tipo: tipo,
                nome: document.getElementById('nome').value,
                cpf: document.getElementById('cpf').value,
                endereco: document.getElementById('endereco').value,
                item: document.getElementById('item').value,
                valor: document.getElementById('valor').value.replace(/\./g, "").replace(",", "."),
                dataInicio: document.getElementById('dataInicio').value,
                dataFim: document.getElementById('dataFim').value
            };

            try {
                await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                alert("‚úÖ Registrado!");
                document.getElementById('formLocacao').reset();
            } catch(e) { alert("Erro ao salvar."); }
        }

        async function finalizarLocacao(linha) {
            if(!confirm("Deseja finalizar?")) return;
            await fetch(URL_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify({tipo: 'finalizar', linha: linha}) });
            setTimeout(abrirRelatorio, 500);
        }

        function filtrarTabela() {
            let f = document.getElementById("inputBusca").value.toUpperCase();
            document.querySelectorAll("#tabelaDados tr").forEach(tr => {
                tr.style.display = tr.innerText.toUpperCase().includes(f) ? "" : "none";
            });
        }
    </script>
</body>
</html>
